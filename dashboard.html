<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard</title>
  <style>
    :root{
      --card:#1b1d36; --text:#ffffff; --muted:rgba(255,255,255,.80);
      --border:rgba(255,255,255,.10); --ok:#20c997; --err:#ff6b6b; --thead:#13142c;
      --totalsA:rgba(255,255,255,.06); --totalsB:rgba(255,255,255,.08);
      --primary:#ffffff; --primaryText:#2e2a8f;
      --bg-gradient:
        radial-gradient(1200px 800px at 20% 20%, #6c5cd7 0%, rgba(108,92,215,.85) 30%, rgba(92,76,196,.85) 55%, rgba(78,62,178,.9) 75%, #4e3eb2 100%),
        linear-gradient(180deg, #5c4cc8 0%, #4b3aa6 100%);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui, Arial, sans-serif; color:var(--text);
      background:var(--bg-gradient); background-attachment:fixed; min-height:100vh; }

    header{ display:flex; align-items:center; gap:12px; padding:12px 16px;
      background:rgba(27,29,54,.92); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5; backdrop-filter: blur(6px); }
    .brand-logo{ height:32px; width:auto; object-fit:contain; }
    header h1{ margin:0; font-size:18px; font-weight:700; }
    .hdr-actions{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0f1129; color:#fff; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn.primary{ background:var(--primary); color:var(--primaryText); border-color:transparent; }
    .btn.logout{ background:#ff6b6b; border-color:transparent; }

    .wrap{ width: clamp(1024px, 96vw, 1600px); margin:0 auto; padding:0 8px 16px; }
    .top-actions{ padding:12px 16px 8px; display:flex; justify-content:flex-end; }
    .muted{ color:var(--muted); }

    .filters{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
    .box{ background:rgba(27,29,54,.92); border:1px solid var(--border); border-radius:12px;
      padding:14px; display:flex; flex-direction:column; gap:10px; backdrop-filter: blur(4px); }
    .box h3{ margin:0; font-size:14px; font-weight:700; }
    .hint{ font-size:12px; color:var(--muted); margin-top:-4px; }
    .field{ background:#0f1129; border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; display:flex; align-items:center; gap:8px; position:relative; }
    label{ font-size:13px; color:var(--muted); white-space:nowrap; }
    select, input[type="text"]{ flex:1; background:transparent; color:#fff; border:none; outline:none; font-size:14px; min-width:0; }
    .toolbar{ display:grid; grid-template-columns: 1fr 100px; gap:8px; align-items:center; }

    .ac-wrap{ position:relative; }
    .ac-list{ position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:#0f1129; border:1px solid var(--border); border-radius:10px;
      box-shadow:0 12px 32px rgba(0,0,0,.45); max-height:260px; overflow:auto; z-index:10; display:none; }
    .ac-list.open{ display:block; }
    .ac-item{ padding:8px 10px; font-weight:600; cursor:pointer; user-select:none; border-bottom:1px solid rgba(255,255,255,.05); }
    .ac-item:last-child{ border-bottom:none; }
    .ac-item:hover,.ac-item.active{ background:#1a1d3b; }
    .ac-empty{ padding:8px 10px; color:var(--muted); }

    .detail-list{ display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; }
    .d-label{ color:var(--muted); font-size:12px; }
    .d-value{ font-weight:700; font-size:13px; }
    .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-weight:700; font-size:11px; border:1px solid var(--border); }
    .badge.ok{ background:rgba(32,201,151,.15); color:#b3ffe8; border-color:rgba(32,201,151,.35); }
    .badge.err{ background:rgba(255,107,107,.15); color:#ffd4d4; border-color:rgba(255,255,255,.35); }

    .table-section{ margin-top:16px; display:none; }
    .table-card{ background:rgba(27,29,54,.92); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .table-title{ margin:0 0 8px; font-size:14px; font-weight:800; }
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:1180px; }
    thead th{ position:sticky; top:0; background:var(--thead); color:#fff; text-align:left; padding:10px 12px;
      border-bottom:1px solid var(--border); z-index:3; font-size:13px; }
    tbody td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); color:#e9e9f3; font-size:13px; }
    tbody tr:hover{ background:rgba(255,255,255,.03); }
    .num{ text-align:right; white-space:nowrap; }
    .totals-row td{ position:sticky; top:42px; background:linear-gradient(0deg, var(--totalsA), var(--totalsB));
      font-weight:800; z-index:2; border-bottom-color:rgba(255,255,255,.18); }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; font-size:11px; border:1px solid var(--border); }
    .pill.CONFIRMED{ background:rgba(32,201,151,.15); color:#b3ffe8; border-color:rgba(32,201,151,.35); }
    .pill.NOTCONFIRMED{ background:rgba(255,193,7,.15); color:#ffe9b3; border-color:rgba(255,255,255,.35); }
    .pill.CANCELLED{ background:rgba(255,107,107,.15); color:#ffd4d4; border-color:rgba(255,255,255,.35); }
    th[data-sort]{ cursor:pointer; user-select:none; }
    th[data-sort]::after{ content:' ‚áÖ'; opacity:.35; }
    th.sorted-asc::after{ content:' ‚ñ≤'; opacity:.9; }
    th.sorted-desc::after{ content:' ‚ñº'; opacity:.9; }
    .surplus{ color:#a8f0c6; font-weight:700; }
    .deficit{ color:#ffb3b3; font-weight:700; }

    /* Status Slicer */
    .slicer{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px; }
    .slice-pill{
      background:#0f1129; border:1px solid var(--border); border-radius:999px;
      padding:6px 10px; font-size:12px; font-weight:800; cursor:pointer; user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .slice-pill .count{ opacity:.9; }
    .slice-pill .sum{ opacity:.9; font-variant-numeric: tabular-nums; }
    .slice-pill.active{ outline:2px solid #ffffff; }
    .slice-pill.ALL{ background:#172047; }

    @page{ size:A4; margin:10mm; }
    @media print{
      body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; background:#fff; color:#000; }
      header{ position:static; background:#fff; color:#000; border-bottom:1px solid #ccc; }
      header h1{ color:#000; }
      .top-actions,.hdr-actions{ display:none !important; }
      .wrap{ width:auto; padding:0; }
      .filters{ display:none; }
      .table-section{ margin-top:8px; }
      .table-card{ background:#fff; border:1px solid #ddd; padding:8px; break-inside:auto; }
      .table-title{ color:#000; margin-bottom:6px; font-size:13px; }
      .table-wrap{ overflow:visible !important; }
      thead th{ position:static; background:#f6f6f6; color:#000; border-bottom:1px solid #ccc; }
      thead{ display:table-header-group; }
      tfoot{ display:table-row-group; }
      tr, td, th{ page-break-inside:avoid; }
      td, th{ padding:6px 8px; font-size:11.5px; }
      .totals-row td{ position:static; background:#eee; }
      .pill{ border:1px solid #999 !important; background:#fafafa !important; color:#000 !important; }
      .surplus, .deficit{ color:#000 !important; }
    }
    @media (max-width:1200px){ .filters{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:640px){ .filters{ grid-template-columns:1fr; } .detail-list{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <img class="brand-logo" src="logo.png" alt="Realty Assistant logo" />
    <h1>Agent Performance Dashboard</h1>
    <div class="hdr-actions">
      <button class="btn" id="btnExport">‚¨áÔ∏è Export (Excel/CSV)</button>
      <button class="btn primary" id="btnPrint">üñ®Ô∏è Print</button>
      <button class="btn logout" id="btnLogout">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="top-actions">
      <span id="loginInfo" class="muted"></span>
    </div>

    <!-- Filters -->
    <section class="filters">
      <div class="box">
        <h3>Please select Role Type</h3>
        <p class="hint">Role Types: FOS, Team Leader, Area Manager, President</p>
        <div class="field">
          <label for="role">Role</label>
          <select id="role">
            <option value="FOS">FOS</option>
            <option value="Team Leader">Team Leader</option>
            <option value="Area Manager">Area Manager</option>
            <option value="President">President</option>
          </select>
        </div>
      </div>

      <div class="box">
        <h3>Please select or Search Name</h3>
        <p class="hint">Type to search, then press Enter or click</p>
        <div class="toolbar">
          <div class="field ac-wrap">
            <label for="search">Search</label>
            <input id="search" type="text" placeholder="Search name..." autocomplete="off" aria-expanded="false" aria-controls="ac-list" />
            <div id="ac-list" class="ac-list" role="listbox" aria-label="Name suggestions"></div>
          </div>
          <button class="btn" id="resetFilters" type="button">Reset</button>
        </div>
        <!-- Fixed, auto-filled President name (read-only) -->
        <div class="hint">
          <strong>President:</strong> <span id="presidentName">‚Äî</span>
        </div>
      </div>

      <div class="box">
        <h3>Employee Details</h3>
        <div class="detail-list">
          <div class="d-label">City</div>        <div class="d-value" id="dCity">‚Äî</div>
          <div class="d-label">Status</div>      <div class="d-value" id="dStatus">‚Äî</div>
          <div class="d-label">DOJ</div>         <div class="d-value" id="dDOJ">‚Äî</div>
          <div class="d-label" id="dolLabel" style="display:none;">DOL</div>
          <div class="d-value" id="dDOL" style="display:none;">‚Äî</div>
          <div class="d-label">Employee Code</div><div class="d-value" id="dCode">‚Äî</div>
          <div class="d-label">PIP TIMES</div>   <div class="d-value"><span id="dPip" class="badge">‚Äî</span></div>
        </div>
      </div>
    </section>

    <!-- ===== Summary (uses sales slicer for revenue) ===== -->
    <section id="summarySection" class="table-section">
      <div class="table-card">
        <h3 class="table-title">Overall Summary</h3>

        <!-- TOP status slicer (multi-select, synced with sales table) -->
        <div id="statusSlicerTop" class="slicer" aria-label="Sales status slicer (top)"></div>

        <div class="table-wrap">
          <table id="tblSummary">
            <thead>
              <tr>
                <th>Total Units</th>
                <th class="num">Cancelled Units</th>
                <th class="num">Active Units</th>
                <th class="num">Salary (Total)</th>
                <th class="num">Marketing (Total)</th>
                <th class="num">Infra (Total)</th>
                <th class="num">Revenue (from Sales slicer)</th>
                <th class="num">Salary √ó 5</th>
                <th class="num">X Achieved</th>
                <th class="num">Surplus / Deficit</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Monthly Performance -->
    <section id="perfSection" class="table-section">
      <div class="table-card">
        <h3 class="table-title" id="perfTitle">Monthly Performance (FOS)</h3>
        <div class="table-wrap">
          <table id="tblPerformance">
            <thead id="perfHead"></thead>
            <tbody id="perfBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Sales Details -->
    <section id="salesSection" class="table-section">
      <div class="table-card">
        <h3 class="table-title" id="salesTitle">Sales Details (FOS)</h3>

        <!-- Sales status slicer (multi-select, synced with top) -->
        <div id="statusSlicer" class="slicer" aria-label="Sales status slicer"></div>

        <div class="table-wrap">
          <table id="tblSales">
            <thead>
              <tr id="salesHeaders">
                <th data-sort="date">Booking Date</th>
                <th data-sort="project">Project</th>
                <th data-sort="client">Client Name</th>
                <th data-sort="unit">Unit No.</th>
                <th data-sort="status">Status</th>
                <th data-sort="revenue" class="num">Revenue</th>
                <th data-sort="flag" class="num">Status Flag</th>
              </tr>
            </thead>
            <tbody id="salesBody"></tbody>
          </table>
        </div>
        <p class="muted">Status Flag: CANCELLED = 0, otherwise = 1</p>
      </div>
    </section>

    <!-- Input Matrix (FOS only) -->
    <section id="fosMatrixSection" class="table-section">
      <div class="table-card">
        <h3 class="table-title">Input Matrix (FOS)</h3>
        <div class="table-wrap">
          <table id="tblMatrix">
            <thead>
              <tr>
                <th>Month</th>
                <th class="num">Total Calls</th>
                <th class="num">Connected Calls</th>
                <th class="num">Duration (mins)</th>
                <th class="num">Site Visits Scheduled</th>
                <th class="num">Site Visits Done</th>
                <th class="num">Meetings Scheduled</th>
                <th class="num">Meetings Done</th>
                <th class="num">Daily Work (entries)</th>
              </tr>
            </thead>
            <tbody id="fosMatrixBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ===== AUTH GUARD ===== */
    const auth = (()=>{ try{return JSON.parse(sessionStorage.getItem('auth')||'null');}catch{return null;} })();
    if(!auth){ location.replace('index.html'); }
    const isAdmin = auth && auth.role === 'admin';
    const lockedUserName = !isAdmin ? (auth?.name || null) : null;
    const lockedUserRole = !isAdmin ? (auth?.role || null) : null;

    /* ===== EMPLOYEES ===== */
    const employees = {
      "FOS": {
        // Add president on each employee you want to map
"JAYESH.JAISWAL": { city: "MUMBAI", status: "ACTIVE", doj: "2025-06-03", dol: null, code: "RA3692", salary: 0, pipTimes: 0 , president: ""},
"MOHAMMAD.RAHIB": { city: "MUMBAI", status: "ACTIVE", doj: "2025-07-21", dol: null, code: "RA3919", salary: 0, pipTimes: 0 , president: ""},
"RESHMA.MALI": { city: "MUMBAI", status: "ACTIVE", doj: "2024-12-06", dol: null, code: "RA3142", salary: 0, pipTimes: 5 , president: ""},
"SHOEB.SHAH": { city: "MUMBAI", status: "ACTIVE", doj: "2024-04-09", dol: null, code: "RA2309", salary: 0, pipTimes: 7 , president: ""},
"SHUBHAM.VISHWAKARMA": { city: "MUMBAI", status: "ACTIVE", doj: "2025-07-21", dol: null, code: "RA3918", salary: 0, pipTimes: 1 , president: ""},
"MUKESH.YADAV": { city: "MUMBAI", status: "ACTIVE", doj: "2025-09-08", dol: null, code: "RA4061", salary: 0, pipTimes: 0 , president: ""},
"VISHAL.TOMAR": { city: "MUMBAI", status: "ACTIVE", doj: "2025-09-16", dol: null, code: "RA4098", salary: 0, pipTimes: 0 , president: ""}
      },
      "Team Leader": {
        "D": { city:"Noida",   status:"Active",   doj:"2022-03-05", dol:null,         code:"RA-TL-010", salary:45000, pipTimes: 0, president:"MOHIT MITTAL" },
        "E": { city:"Delhi",   status:"Inactive", doj:"2021-08-20", dol:"2023-12-31", code:"RA-TL-011", salary:42000, pipTimes: 0, president:"MOHIT MITTAL" }
      },
      "Area Manager": {
        "G": { city:"Noida",   status:"Active",   doj:"2020-06-15", dol:null,         code:"RA-AM-101", salary:65000, pipTimes: 0, president:"MOHIT MITTAL" },
        "H": { city:"Kanpur",  status:"Inactive", doj:"2019-04-10", dol:"2022-10-05", code:"RA-AM-102", salary:60000, pipTimes: 0, president:"MOHIT MITTAL" }
      },
      "President": {
        "MANASVI.MEHROTRA": { city: "NOIDA", status: "ACTIVE", doj: "2020-09-22", dol: null, code: "RA24", salary: 0, pipTimes: 0 , president: "MANASVI MEHROTRA"},
"MOHIT.MITTAL": { city: "NOIDA", status: "ACTIVE", doj: "2022-06-21", dol: null, code: "VV04", salary: 0, pipTimes: 0 , president: "MOHIT MITTAL"},
"RAHUL.BHATIA": { city: "NOIDA", status: "ACTIVE", doj: "2020-01-01", dol: null, code: "RA02", salary: 0, pipTimes: 0 , president: "RAHUL BHATIA"},
      }
    };

    /* ===== MONTHLY PERFORMANCE DATA ===== */
    const perfData = {
      "FOS": {
      "SHOEB.SHAH":{"2024-04": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:32267},
"2024-05": { total:3, cancelled:1, marketing:0, infra:0, revenue:242794.59,salary:44000},
"2024-06": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2024-07": { total:3, cancelled:3, marketing:0, infra:0, revenue:0,salary:44000},
"2024-08": { total:2, cancelled:2, marketing:0, infra:0, revenue:0,salary:44000},
"2024-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2024-10": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:44000},
"2024-11": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2024-12": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:44000},
"2025-01": { total:3, cancelled:3, marketing:0, infra:0, revenue:0,salary:44000},
"2025-02": { total:2, cancelled:1, marketing:0, infra:0, revenue:242550,salary:44000},
"2025-03": { total:2, cancelled:1, marketing:0, infra:0, revenue:233083.374,salary:44000},
"2025-04": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2025-05": { total:1, cancelled:0, marketing:0, infra:0, revenue:437247.99,salary:44000},
"2025-06": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2025-07": { total:1, cancelled:0, marketing:0, infra:0, revenue:121125,salary:44000},
"2025-08": { total:1, cancelled:0, marketing:0, infra:0, revenue:121125,salary:44000},
"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:44000},
"2025-10": { total:1, cancelled:0, marketing:0, infra:0, revenue:121285.125,salary:44000}},
"RESHMA.MALI":{"2024-12": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:51161},
"2025-01": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:61000},
"2025-02": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:61000},
"2025-03": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:61000},
"2025-04": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:61000},
"2025-05": { total:1, cancelled:1, marketing:0, infra:0, revenue:0,salary:61000},
"2025-06": { total:2, cancelled:2, marketing:0, infra:0, revenue:0,salary:61000},
"2025-07": { total:2, cancelled:0, marketing:0, infra:0, revenue:307625,salary:61000},
"2025-08": { total:15, cancelled:2, marketing:0, infra:0, revenue:1856138.425,salary:61000},
"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:61000},
"2025-10": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:61000}},
"JAYESH.JAISWAL":{"2025-06": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:27627},
"2025-07": { total:1, cancelled:0, marketing:0, infra:0, revenue:108375,salary:29600},
"2025-08": { total:1, cancelled:0, marketing:0, infra:0, revenue:121125,salary:29600},
"2025-09": { total:1, cancelled:0, marketing:0, infra:0, revenue:82875,salary:29600},
"2025-10": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:29600}},
"SHUBHAM.VISHWAKARMA":{"2025-07": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:12277},
"2025-08": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:34600},
"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:34600},
"2025-10": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:34600}},
"MOHAMMAD.RAHIB":{"2025-07": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:11000},
"2025-08": { total:1, cancelled:0, marketing:0, infra:0, revenue:121125,salary:31000},
"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:31000},
"2025-10": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:31000}},
"MUKESH.YADAV":{"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:46460},
"2025-10": { total:1, cancelled:0, marketing:0, infra:0, revenue:361835.94,salary:60600}},
"VISHAL.TOMAR":{"2025-09": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:15000},
"2025-10": { total:0, cancelled:0, marketing:0, infra:0, revenue:0,salary:30000}}
},
      "Team Leader": { "D": {}, "E": {} },
      "Area Manager":{ "G": {}, "H": {} },
      "President":   { "X": {} }
    };

    /* ===== SALES ===== */
    const salesData = {
      "FOS": {
        "SHOEB.SHAH":[{date:"2024-05-05",project:"EXOTIQUE KHARGHAR",client:"HUSAYN AHMED CHOGULE",unit:"D-2006",status:"CANCELLED",revenue:0},
{date:"2024-05-05",project:"OMKARA PRIDE",client:"MS HABIBA BANO & MS LAIBA BANO",unit:"-",status:"CONFIRMED",revenue:135049.59},
{date:"2024-05-12",project:"SAI SUN CITY",client:"KUSUM TIWARI",unit:"1808",status:"CONFIRMED",revenue:107745},
{date:"2024-07-07",project:"SAI SUN CITY",client:"ABUL KASHEM",unit:"401",status:"CANCELLED",revenue:0},
{date:"2024-07-09",project:"EXOTIQUE KHARGHAR",client:"ASHISH KUMAR PAL",unit:"-",status:"CANCELLED",revenue:0},
{date:"2024-07-17",project:"NIHARIKA ABSOLUTE KHARGHAR",client:"BHASKAR DATTARAM SAWANT / GAURAV SHAWANT",unit:"D 701",status:"CANCELLED",revenue:0},
{date:"2024-08-18",project:"EXOTIQUE KHARGHAR",client:"BASANT KUMAR THAILIANI",unit:"E-1001",status:"CANCELLED",revenue:0},
{date:"2024-08-29",project:"NIHARIKA ABSOLUTE KHARGHAR",client:"LATHA BAWA",unit:"C WING 302",status:"CANCELLED",revenue:0},
{date:"2024-10-30",project:"HERITAGE",client:"SAGAR NANDALAL PARDESHI",unit:"HE A 803",status:"CANCELLED",revenue:0},
{date:"2024-12-26",project:"JUHI NIHARIKA",client:"UJWALA DABHADE",unit:"D 905",status:"CANCELLED",revenue:0},
{date:"2025-01-15",project:"LNT NEW LAUNCH",client:"MOSHIN KADAR PATEL",unit:"11 FLOOR",status:"CANCELLED",revenue:0},
{date:"2025-01-17",project:"LNT NEW LAUNCH",client:"SAMINA SAYYED",unit:"FLOOR 32 4 BHK",status:"CANCELLED",revenue:0},
{date:"2025-01-26",project:"DREAM MEADOWS",client:"PARUL VASHISHTA",unit:"1 BHK 5TH FLOOR",status:"CANCELLED",revenue:0},
{date:"2025-02-09",project:"ASPIRE",client:"PASHETTY NAGNATA",unit:"AP 1601",status:"CANCELLED",revenue:0},
{date:"2025-02-09",project:"ASPIRE",client:"PASHETTY NAGNATH",unit:"AP -1601",status:"CONFIRMED",revenue:242550},
{date:"2025-03-09",project:"SATYAM NEXT LEVEL KHARGHAR",client:"PRITI UDAY CHANDAN",unit:"A 1607",status:"CONFIRMED",revenue:233083.374},
{date:"2025-03-23",project:"ASPIRE",client:"ARUN LAXMAN KADAV",unit:"CATALINA - 3503",status:"CANCELLED",revenue:0},
{date:"2025-05-12",project:"SAI WORLD EMPIRE",client:"ASHUTOSH SUNDARAM /KEETA PRASAD",unit:"TOWER 2 ALEXANDER 3608",status:"CONFIRMED",revenue:437247.99},
{date:"2025-07-26",project:"LA MER ONE",client:"CHRISTOPHER DMELLO",unit:"B6-214",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-24",project:"LA MER ONE",client:"SANGITA DNYNOBA JOGDAND",unit:"B6- 1108",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-10-17",project:"LA MER ONE",client:"SACHIN KHARE",unit:"B4-1305",status:"NOT CONFIRMED",revenue:121285.125}],
"RESHMA.MALI":[{date:"2025-01-27",project:"PLATINUM PARKSYDE",client:"RAJ BAKSHI",unit:"NA",status:"CANCELLED",revenue:0},
{date:"2025-02-19",project:"MAXIMUS CITY",client:"ATESH ANANDA DESAI",unit:"A 1402",status:"CANCELLED",revenue:0},
{date:"2025-04-06",project:"PLATINUM MANSIONZ",client:"ISABELLE FERNANDEZ",unit:"502",status:"CANCELLED",revenue:0},
{date:"2025-05-01",project:"EXOTIQUE KHARGHAR",client:"ANKITA AKASH SHINDE / AKASH SAMBHAJI SHINDE",unit:"A 104",status:"CANCELLED",revenue:0},
{date:"2025-06-08",project:"SAI WORLD ONE",client:"ROHIT SHUKLA",unit:"3 BHK",status:"CANCELLED",revenue:0},
{date:"2025-06-29",project:"CENTURY NEXUS",client:"TEJAL RUPESH GAWAND / RUPESH SADANAND GAVAND",unit:"610",status:"CANCELLED",revenue:0},
{date:"2025-07-22",project:"LA MER ONE",client:"GANESH RAMESH MHATRE",unit:"B6-413",status:"NOT CONFIRMED",revenue:110500},
{date:"2025-07-26",project:"LA MER ONE",client:"PRAMOD ANANT SONDKAR",unit:"B3-1701",status:"NOT CONFIRMED",revenue:197125},
{date:"2025-08-02",project:"LA MER ONE",client:"DEEPAK BANDU NARAYANKAR",unit:"B5-606",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-03",project:"LA MER ONE",client:"JYOTI RAMDAS GAIKWAD",unit:"B5-1112",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-03",project:"LA MER ONE",client:"MACHINDRA HOTKAR",unit:"B5-1408",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-03",project:"LA MER ONE",client:"USHA HOTKAR",unit:"B5-1409",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-05",project:"LA MER ONE",client:"JAYMALA GANESH VARPE",unit:"B5 1412",status:"CANCELLED",revenue:0},
{date:"2025-08-05",project:"LA MER ONE",client:"RESHMA GAUTAM WAKODE",unit:"B5 307",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-10",project:"LA MER ONE",client:"NEHA NITIN DABHOLKAR",unit:"B31906",status:"NOT CONFIRMED",revenue:263530.875},
{date:"2025-08-16",project:"LA MER ONE",client:"SUBHASH MOTIRAM JOGDAND",unit:"B4-1006",status:"NOT CONFIRMED",revenue:190678.775},
{date:"2025-08-16",project:"LA MER ONE",client:"SUBHASH MOTIRAM JOGDAND",unit:"B4-1007",status:"NOT CONFIRMED",revenue:190678.775},
{date:"2025-08-17",project:"LA MER ONE",client:"RUTIK NAMDEV NARAYANKAR",unit:"B6-2209",status:"CANCELLED",revenue:0},
{date:"2025-08-24",project:"LA MER ONE",client:"RUTIK NAMDEV NARAYANKAR",unit:"B6-1402",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-24",project:"LA MER ONE",client:"OMKAR SANJAY SARGAR",unit:"B5-2006",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-24",project:"LA MER ONE",client:"RUSHIKESH AJINATH WANVE",unit:"B5-2009",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-24",project:"LA MER ONE",client:"ANKIT SANJAY SARGAR",unit:"B5-2007",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-08-25",project:"LA MER ONE",client:"YASH APPASO MANE",unit:"B5-604",status:"NOT CONFIRMED",revenue:121125}],
"JAYESH.JAISWAL":[{date:"2025-07-27",project:"LA MER ONE",client:"AMAR BALKRUSHNA CHIKANE",unit:"1601",status:"NOT CONFIRMED",revenue:108375},
{date:"2025-08-03",project:"LA MER ONE",client:"SHRIDHAR SUNIL DOIPHODE",unit:"B-5 204",status:"NOT CONFIRMED",revenue:121125},
{date:"2025-09-30",project:"LA MER ONE",client:"PRAVEEN MISRA",unit:"2101",status:"NOT CONFIRMED",revenue:82875}],
"MOHAMMAD.RAHIB":[{date:"2025-08-25",project:"LA MER ONE",client:"VIJAY SHIVAJI MANE",unit:"B5-2111",status:"NOT CONFIRMED",revenue:121125}],
"MUKESH.YADAV":[{date:"2025-10-02",project:"HANGING GARDEN",client:"YOGESH VASUDEV DHUMAL",unit:"1704",status:"NOT CONFIRMED",revenue:361835.94}]
      },
      "Team Leader": { "D":[ ], "E":[ ] },
      "Area Manager": { "G":[ ], "H":[ ] },
      "President": { "X":[ ] }
    };

    /* ===== FOS Input Matrix ===== */
    const matrixFOS = {
      "JAYESH.JAISWAL":{"2025-06":{calls:1392,connected:208,duration:12,svSched:4,svDone:5,mtgSched:3,mtgDone:0,dailyWork:1704},
"2025-07":{calls:811,connected:55,duration:1,svSched:12,svDone:11,mtgSched:2,mtgDone:1,dailyWork:1244},
"2025-08":{calls:734,connected:144,duration:19,svSched:3,svDone:2,mtgSched:0,mtgDone:0,dailyWork:1248},
"2025-09":{calls:76,connected:12,duration:8,svSched:0,svDone:0,mtgSched:0,mtgDone:1,dailyWork:479},
"2025-10":{calls:1,connected:0,duration:0,svSched:1,svDone:0,mtgSched:1,mtgDone:2,dailyWork:2013}},
"MOHAMMAD.RAHIB":{"2025-07":{calls:608,connected:188,duration:23,svSched:3,svDone:2,mtgSched:1,mtgDone:0,dailyWork:562},
"2025-08":{calls:836,connected:132,duration:9,svSched:6,svDone:4,mtgSched:0,mtgDone:0,dailyWork:1032},
"2025-09":{calls:351,connected:61,duration:14,svSched:0,svDone:2,mtgSched:0,mtgDone:0,dailyWork:386},
"2025-10":{calls:400,connected:164,duration:94,svSched:1,svDone:1,mtgSched:0,mtgDone:0,dailyWork:524}},
"MUKESH.YADAV":{"2025-09":{calls:0,connected:0,duration:0,svSched:0,svDone:1,mtgSched:0,mtgDone:0,dailyWork:0},
"2025-10":{calls:0,connected:0,duration:0,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:256}},
"RESHMA.MALI":{"2024-12":{calls:1550,connected:408,duration:11,svSched:3,svDone:6,mtgSched:3,mtgDone:1,dailyWork:641},
"2025-01":{calls:767,connected:174,duration:12,svSched:20,svDone:15,mtgSched:6,mtgDone:0,dailyWork:1492},
"2025-02":{calls:64,connected:20,duration:19,svSched:12,svDone:11,mtgSched:3,mtgDone:0,dailyWork:1162},
"2025-03":{calls:67,connected:19,duration:6,svSched:13,svDone:6,mtgSched:1,mtgDone:0,dailyWork:979},
"2025-04":{calls:54,connected:15,duration:12,svSched:10,svDone:5,mtgSched:23,mtgDone:1,dailyWork:1063},
"2025-05":{calls:100,connected:30,duration:17,svSched:18,svDone:5,mtgSched:0,mtgDone:0,dailyWork:914},
"2025-06":{calls:168,connected:57,duration:18,svSched:27,svDone:11,mtgSched:1,mtgDone:1,dailyWork:858},
"2025-07":{calls:552,connected:188,duration:23,svSched:39,svDone:19,mtgSched:1,mtgDone:0,dailyWork:2153},
"2025-08":{calls:63,connected:17,duration:2,svSched:18,svDone:25,mtgSched:0,mtgDone:1,dailyWork:1063},
"2025-09":{calls:2,connected:1,duration:0,svSched:0,svDone:1,mtgSched:0,mtgDone:0,dailyWork:323},
"2025-10":{calls:1,connected:1,duration:0,svSched:1,svDone:3,mtgSched:0,mtgDone:0,dailyWork:339}},
"SHOEB.SHAH":{"2024-04":{calls:538,connected:155,duration:4,svSched:2,svDone:4,mtgSched:0,mtgDone:0,dailyWork:520},
"2024-05":{calls:1142,connected:331,duration:3,svSched:17,svDone:11,mtgSched:2,mtgDone:1,dailyWork:1150},
"2024-06":{calls:1280,connected:296,duration:16,svSched:27,svDone:9,mtgSched:1,mtgDone:2,dailyWork:1989},
"2024-07":{calls:2196,connected:550,duration:13,svSched:22,svDone:12,mtgSched:0,mtgDone:0,dailyWork:3451},
"2024-08":{calls:1517,connected:346,duration:12,svSched:24,svDone:16,mtgSched:0,mtgDone:0,dailyWork:2708},
"2024-09":{calls:281,connected:77,duration:6,svSched:17,svDone:10,mtgSched:0,mtgDone:0,dailyWork:1930},
"2024-10":{calls:157,connected:36,duration:18,svSched:13,svDone:6,mtgSched:0,mtgDone:0,dailyWork:1791},
"2024-11":{calls:46,connected:13,duration:9,svSched:16,svDone:9,mtgSched:4,mtgDone:3,dailyWork:1066},
"2024-12":{calls:17,connected:6,duration:1,svSched:22,svDone:11,mtgSched:0,mtgDone:0,dailyWork:1072},
"2025-01":{calls:1,connected:0,duration:0,svSched:15,svDone:6,mtgSched:3,mtgDone:3,dailyWork:1145},
"2025-02":{calls:0,connected:0,duration:0,svSched:12,svDone:4,mtgSched:0,mtgDone:0,dailyWork:887},
"2025-03":{calls:6,connected:1,duration:0,svSched:10,svDone:6,mtgSched:1,mtgDone:0,dailyWork:786},
"2025-04":{calls:1,connected:0,duration:0,svSched:8,svDone:3,mtgSched:4,mtgDone:0,dailyWork:742},
"2025-05":{calls:0,connected:0,duration:0,svSched:10,svDone:4,mtgSched:0,mtgDone:0,dailyWork:789},
"2025-06":{calls:0,connected:0,duration:0,svSched:11,svDone:7,mtgSched:0,mtgDone:0,dailyWork:980},
"2025-07":{calls:127,connected:0,duration:0,svSched:24,svDone:11,mtgSched:0,mtgDone:0,dailyWork:1977},
"2025-08":{calls:27,connected:0,duration:0,svSched:9,svDone:4,mtgSched:0,mtgDone:0,dailyWork:831},
"2025-09":{calls:2,connected:0,duration:0,svSched:3,svDone:0,mtgSched:0,mtgDone:0,dailyWork:340},
"2025-10":{calls:0,connected:0,duration:0,svSched:3,svDone:3,mtgSched:0,mtgDone:0,dailyWork:192}},
"SHUBHAM.VISHWAKARMA":{"2025-07":{calls:142,connected:46,duration:5,svSched:1,svDone:1,mtgSched:0,mtgDone:0,dailyWork:166},
"2025-08":{calls:784,connected:208,duration:12,svSched:3,svDone:3,mtgSched:0,mtgDone:0,dailyWork:1118},
"2025-09":{calls:109,connected:15,duration:19,svSched:1,svDone:0,mtgSched:0,mtgDone:0,dailyWork:296},
"2025-10":{calls:145,connected:48,duration:41,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:363}},
"VISHAL.TOMAR":{"2025-09":{calls:0,connected:0,duration:0,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:0},
"2025-10":{calls:202,connected:49,duration:28,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:312}}
    };

    /* ===== ELEMENTS ===== */
    const roleSel     = document.getElementById('role');
    const searchInput = document.getElementById('search');
    const acList      = document.getElementById('ac-list');

    const dCity   = document.getElementById('dCity');
    const dStatus = document.getElementById('dStatus');
    const dDOJ    = document.getElementById('dDOJ');
    const dDOL    = document.getElementById('dDOL');
    const dCode   = document.getElementById('dCode');
    const dPip    = document.getElementById('dPip');
    const dolLabel= document.getElementById('dolLabel');

    const presidentNameEl = document.getElementById('presidentName');

    const perfSection = document.getElementById('perfSection');
    const perfBody    = document.getElementById('perfBody');
    const perfHead    = document.getElementById('perfHead');
    const perfTitle   = document.getElementById('perfTitle');

    const salesSection= document.getElementById('salesSection');
    const salesBody   = document.getElementById('salesBody');
    const salesTitle  = document.getElementById('salesTitle');
    const statusSlicer= document.getElementById('statusSlicer');

    const fosMatrixSection = document.getElementById('fosMatrixSection');
    const fosMatrixBody    = document.getElementById('fosMatrixBody');

    const loginInfo = document.getElementById('loginInfo');

    // Summary elements
    const statusSlicerTop = document.getElementById('statusSlicerTop');
    const summarySection  = document.getElementById('summarySection');
    const summaryBody     = document.getElementById('summaryBody');

    /* ===== STATE / HELPERS ===== */
    let state = { role: roleSel.value, name: null };
    let acIndex = -1;
    let salesSort = { key: null, asc: true };
    // Multi-select status filter ‚Äî empty Set = ALL
    let salesFilters = new Set();

    function norm(s){ return (s||'').toString().trim().replace(/\s+/g,' ').toUpperCase(); }
    const fmtDate = (iso)=> !iso ? '‚Äî' : new Date(iso+"T00:00:00").toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
    const fmtINR  = (n)=> n==null ? '‚Äî' : n.toLocaleString('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0});
    const fmtX    = (x)=> isFinite(x) ? (Math.round(x*100)/100).toFixed(2) + '√ó' : '‚Äî';
    const pct     = (n,d)=> d? ((n/d)*100).toFixed(1)+'%' : '‚Äî';

    function normStatus(s){
      const x = String(s||'').toUpperCase().trim();
      if(x === 'NOT CONFIRMED' || x === 'NOTCONFIRMED') return 'NOT CONFIRMED';
      return x;
    }

    function namesForRole(role){
      const all = Object.keys(employees[role] || {});
      if(isAdmin) return all;
      if(lockedUserRole === role && lockedUserName && all.includes(lockedUserName)) return [lockedUserName];
      return [];
    }
    function filterNames(q){
      const list = namesForRole(state.role);
      if(!q) return list;
      q=norm(q);
      return list.filter(n=>n.includes(q));
    }
    function monthRange(doj, dol){
      const start = new Date(doj.slice(0,7)+"-01T00:00:00");
      const end = dol ? new Date(dol.slice(0,7)+"-01T00:00:00") : new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      const arr = []; const d = new Date(start);
      while(d <= end){
        const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0');
        arr.push({ key: `${y}-${m}`, label: d.toLocaleString('en-IN',{month:'short', year:'numeric'}) });
        d.setMonth(d.getMonth()+1);
      }
      return arr;
    }

    /* ===== Build performance header dynamically ===== */
    function buildPerfHeader(showTeamCols){
      const baseCols = `
        <tr>
          <th>Month</th>
          <th class="num">Total Units</th>
          <th class="num">Cancelled Units</th>
          <th class="num">Active Units</th>
          <th class="num">Salary</th>
          <th class="num">Marketing Expense</th>
          <th class="num">Infra</th>
          <th class="num">Revenue</th>
          <th class="num">Salary √ó 5</th>
          <th class="num">X Achieved</th>
          <th class="num">Surplus / Deficit</th>
          ${showTeamCols ? `
            <th class="num">Total Team</th>
            <th class="num">Active Employees</th>
            <th class="num">Active %</th>` : ``}
        </tr>`;
      perfHead.innerHTML = baseCols;
    }

    /* ===== AUTOCOMPLETE ===== */
    function openAC(items){
      acList.innerHTML = items.length
        ? items.map((n,i)=>`<div class="ac-item${i===0?' active':''}" role="option">${n}</div>`).join('')
        : `<div class="ac-empty">No names found</div>`;
      acList.classList.add('open'); searchInput.setAttribute('aria-expanded','true'); acIndex = items.length?0:-1;
      [...acList.querySelectorAll('.ac-item')].forEach(el=>{
        el.addEventListener('mousedown', (e)=>{ e.preventDefault(); selectName(el.textContent.trim()); });
      });
    }
    function closeAC(){ acList.classList.remove('open'); searchInput.setAttribute('aria-expanded','false'); acIndex=-1; }
    function refreshAC(){ openAC(filterNames(searchInput.value.trim())); }
    function moveActive(delta){
      const items = [...acList.querySelectorAll('.ac-item')]; if(!items.length) return;
      acIndex = (acIndex + delta + items.length) % items.length;
      items.forEach(el=>el.classList.remove('active')); items[acIndex].classList.add('active'); items[acIndex].scrollIntoView({block:'nearest'});
    }

    /* ===== SELECT + DETAILS ===== */
    function selectName(name){
      state.name = name; searchInput.value = name; closeAC();
      renderAll();
    }
    function updatePresident(){
      const p = ((employees[state.role]||{})[state.name]||{}).president;
      presidentNameEl.textContent = p || '‚Äî';
    }
    function updateDetails(){
      const data = (employees[state.role] || {})[state.name || ''] || null;
      if(!data){
        dCity.textContent='‚Äî'; dStatus.textContent='‚Äî'; dStatus.className='';
        dDOJ.textContent='‚Äî'; dDOL.textContent='‚Äî'; dCode.textContent='‚Äî';
        dPip.textContent='‚Äî'; dPip.className='badge';
        dolLabel.style.display='none'; dDOL.style.display='none'; return;
      }
      dCity.textContent = data.city || '‚Äî';
      const isActive = String(data.status || '').toUpperCase() === 'ACTIVE';
      dStatus.textContent = data.status || '‚Äî';
      dStatus.className = 'badge ' + (isActive ? 'ok' : 'err');
      dDOJ.textContent = fmtDate(data.doj);
      if(!isActive && data.dol){
        dolLabel.style.display=''; dDOL.style.display=''; dDOL.textContent = fmtDate(data.dol);
      } else { dolLabel.style.display='none'; dDOL.style.display='none'; dDOL.textContent='‚Äî'; }
      dCode.textContent = data.code || '‚Äî';

      const pip = data.pipTimes;
      if (Number.isFinite(pip)) {
        dPip.textContent = pip;
        dPip.className = 'badge ' + (pip > 0 ? 'err' : 'ok');
      } else {
        dPip.textContent = '‚Äî';
        dPip.className = 'badge';
      }
    }

    /* ===== SUMMARY (top card) ===== */
    function computePerfTotals(role, name){
      const emp = (employees[role]||{})[name];
      const monthly = ((perfData[role]||{})[name]) || {};
      if(!emp) return null;

      const months = monthRange(emp.doj, emp.dol);
      const sum = {total:0,cancelled:0,active:0,salary:0,marketing:0,infra:0,target:0};

      months.forEach(m=>{
        const r = monthly[m.key] || {total:0,cancelled:0,marketing:0,infra:0,revenue:0,salary:emp.salary};
        const salary = r.salary ?? emp.salary ?? 0;
        const activeUnits = Math.max((r.total||0)-(r.cancelled||0),0);
        sum.total      += r.total||0;
        sum.cancelled  += r.cancelled||0;
        sum.active     += activeUnits;
        sum.salary     += salary;
        sum.marketing  += r.marketing||0;
        sum.infra      += r.infra||0;
        sum.target     += salary*5;
      });
      return sum;
    }

    function revenueFromSelectedSales(role, name){
      const rows = (((salesData[role]||{})[name])||[]);
      if(salesFilters.size === 0){
        return rows.reduce((t,r)=> t + (Number(r.revenue)||0), 0);
      }
      return rows.reduce((t,r)=>{
        const s = normStatus(r.status);
        return t + (salesFilters.has(s) ? (Number(r.revenue)||0) : 0);
      }, 0);
    }

    function buildStatusSlicerMulti(rows, container){
      const agg = rows.reduce((m,r)=>{
        const s = normStatus(r.status);
        if(!m[s]) m[s] = {count:0, revenue:0};
        m[s].count += 1;
        m[s].revenue += Number(r.revenue)||0;
        return m;
      }, {});
      const allCount   = rows.length;
      const allRevenue = rows.reduce((t,r)=> t + (Number(r.revenue)||0), 0);
      const isAll = salesFilters.size === 0;

      const statuses = Object.keys(agg);
      const pills = [
        `<div class="slice-pill ALL ${isAll?'active':''}" data-status="__ALL__">
           <span>All</span>
           <span class="count">(${allCount})</span>
           <span class="sum">${fmtINR(allRevenue)}</span>
         </div>`
      ].concat(statuses.map(s=>{
        const active = isAll || salesFilters.has(s);
        return `
          <div class="slice-pill ${s.replace(/\s+/g,'')}${active?' active':''}" data-status="${s}">
            <span>${s}</span>
            <span class="count">(${agg[s].count})</span>
            <span class="sum">${fmtINR(agg[s].revenue)}</span>
          </div>`;
      }));

      container.innerHTML = pills.join('');
      container.querySelectorAll('.slice-pill').forEach(el=>{
        el.addEventListener('click', ()=>{
          const s = el.dataset.status;
          if(s === '__ALL__'){
            salesFilters.clear();
          }else{
            if(salesFilters.size === 0) salesFilters.add(s);
            else if(salesFilters.has(s)) salesFilters.delete(s);
            else salesFilters.add(s);
            if(salesFilters.size === 0) salesFilters.clear();
          }
          renderSales();
          renderSummary();
        });
      });
    }

    function renderSummary(){
      const role = state.role, name = state.name;
      if(!name){ summarySection.style.display='none'; summaryBody.innerHTML=''; return; }

      const perfTotals = computePerfTotals(role, name);
      const allRows = (((salesData[role]||{})[name])||[]);
      buildStatusSlicerMulti(allRows, statusSlicerTop);

      const revenue = revenueFromSelectedSales(role, name);
      const xAchieved = perfTotals && perfTotals.salary ? (revenue / perfTotals.salary) : 0;
      const surplus   = revenue - (perfTotals ? perfTotals.target : 0);

      if(!perfTotals){
        summaryBody.innerHTML = `<tr><td colspan="10" class="muted">No data.</td></tr>`;
        summarySection.style.display='block';
        return;
      }

      summaryBody.innerHTML = `
        <tr>
          <td>${perfTotals.total}</td>
          <td class="num">${perfTotals.cancelled}</td>
          <td class="num">${perfTotals.active}</td>
          <td class="num">${fmtINR(perfTotals.salary)}</td>
          <td class="num">${fmtINR(perfTotals.marketing)}</td>
          <td class="num">${fmtINR(perfTotals.infra)}</td>
          <td class="num">${fmtINR(revenue)}</td>
          <td class="num">${fmtINR(perfTotals.target)}</td>
          <td class="num">${fmtX(xAchieved)}</td>
          <td class="num ${surplus>=0?'surplus':'deficit'}">${surplus>=0?'+':''}${fmtINR(Math.abs(surplus))}</td>
        </tr>`;
      summarySection.style.display='block';
    }

    /* ===== PERFORMANCE TABLE ===== */
    function renderPerformance(){
      const role = state.role, name = state.name;
      perfTitle.textContent = `Monthly Performance (${role})`;
      if(!name){ perfSection.style.display='none'; perfBody.innerHTML=''; return; }

      const emp = (employees[role]||{})[name];
      const monthly = ((perfData[role]||{})[name]) || {};
      if(!emp){ perfSection.style.display='none'; return; }

      const showTeamCols = (role !== 'FOS');
      buildPerfHeader(showTeamCols);

      const months = monthRange(emp.doj, emp.dol);
      let sum = {total:0,cancelled:0,active:0,marketing:0,infra:0,revenue:0,salary:0,target:0,teamTotal:0,teamActive:0};

      const rows = months.map(m=>{
        const r = monthly[m.key] || {total:0,cancelled:0,marketing:0,infra:0,revenue:0,salary:emp.salary};
        const salary = r.salary ?? emp.salary ?? 0;
        const activeUnits = Math.max((r.total||0)-(r.cancelled||0),0);
        const salaryX5 = salary*5;
        const xFactor = salary ? ((r.revenue||0)/salary) : 0;
        const surplus = (r.revenue||0) - salaryX5;

        sum.total += r.total||0;
        sum.cancelled += r.cancelled||0;
        sum.active += activeUnits;
        sum.marketing += r.marketing||0;
        sum.infra += r.infra||0;
        sum.revenue += r.revenue||0;
        sum.salary += salary;
        sum.target += salaryX5;

        let teamCols = '';
        if(showTeamCols){
          const tTot = r.teamTotal || 0, tAct = r.teamActive || 0;
          sum.teamTotal += tTot; sum.teamActive += tAct;
          teamCols = `
            <td class="num">${tTot||'‚Äî'}</td>
            <td class="num">${tAct||'‚Äî'}</td>
            <td class="num">${tTot? pct(tAct,tTot) : '‚Äî'}</td>`;
        }

        return `<tr>
          <td>${m.label}</td>
          <td class="num">${r.total||0}</td>
          <td class="num">${r.cancelled||0}</td>
          <td class="num">${activeUnits}</td>
          <td class="num">${fmtINR(salary)}</td>
          <td class="num">${fmtINR(r.marketing||0)}</td>
          <td class="num">${fmtINR(r.infra||0)}</td>
          <td class="num">${fmtINR(r.revenue||0)}</td>
          <td class="num">${fmtINR(salaryX5)}</td>
          <td class="num">${fmtX(xFactor)}</td>
          <td class="num ${surplus>=0?'surplus':'deficit'}">${surplus>=0?'+':''}${fmtINR(Math.abs(surplus))}</td>
          ${teamCols}
        </tr>`;
      }).join('');

      const xAchievedTotal = sum.salary ? (sum.revenue/sum.salary) : 0;
      const surplusTotal = sum.revenue - sum.target;

      let totalsRow = `
        <tr class="totals-row">
          <td>Total</td>
          <td class="num">${sum.total}</td>
          <td class="num">${sum.cancelled}</td>
          <td class="num">${sum.active}</td>
          <td class="num">${fmtINR(sum.salary)}</td>
          <td class="num">${fmtINR(sum.marketing)}</td>
          <td class="num">${fmtINR(sum.infra)}</td>
          <td class="num">${fmtINR(sum.revenue)}</td>
          <td class="num">${fmtINR(sum.target)}</td>
          <td class="num">${fmtX(xAchievedTotal)}</td>
          <td class="num ${surplusTotal>=0?'surplus':'deficit'}">${surplusTotal>=0?'+':''}${fmtINR(Math.abs(surplusTotal))}</td>`;

      if(showTeamCols){
        totalsRow += `
          <td class="num">${sum.teamTotal||'‚Äî'}</td>
          <td class="num">${sum.teamActive||'‚Äî'}</td>
          <td class="num">${sum.teamTotal? pct(sum.teamActive,sum.teamTotal) : '‚Äî'}</td>`;
      }
      totalsRow += '</tr>';

      perfBody.innerHTML = totalsRow + rows;
      perfSection.style.display='block';
    }

    /* ===== SALES TABLE ===== */
    function flagFromStatus(status){ return String(status||'').toUpperCase()==='CANCELLED' ? 0 : 1; }
    function pillClass(status){
      const s = normStatus(status);
      if(s==='CANCELLED') return 'CANCELLED';
      if(s==='CONFIRMED') return 'CONFIRMED';
      return 'NOTCONFIRMED';
    }
    function getSortableVal(row, key){
      switch(key){
        case 'date':    return new Date(row.date).getTime();
        case 'revenue': return Number(row.revenue) || 0;
        case 'flag':    return flagFromStatus(row.status);
        case 'status':  return String(row.status || '').toLowerCase();
        case 'project': return String(row.project || '').toLowerCase();
        case 'client':  return String(row.client || '').toLowerCase();
        case 'unit':    return String(row.unit || '').toLowerCase();
        default:        return '';
      }
    }
    function sortSales(data, key, asc){
      return [...data].sort((a,b)=>{
        const x = getSortableVal(a, key), y = getSortableVal(b, key);
        if(x===y) return 0; return asc ? (x>y?1:-1) : (x<y?1:-1);
      });
    }
    function updateSalesHeaderSortIndicators(){
      const headerRow = document.getElementById('salesHeaders');
      [...headerRow.children].forEach(th=>{
        th.classList.remove('sorted-asc','sorted-desc');
        const k = th.dataset.sort;
        if(!k) return;
        if(salesSort.key === k){ th.classList.add(salesSort.asc?'sorted-asc':'sorted-desc'); }
      });
    }
    function renderSales(){
      const role = state.role, name = state.name;
      salesTitle.textContent = `Sales Details (${role})`;
      if(!name){
        salesSection.style.display='none'; salesBody.innerHTML=''; statusSlicer.innerHTML='';
        return;
      }
      const allRows = (((salesData[role]||{})[name])||[]);

      // Build (multi-select) slicer for sales section
      buildStatusSlicerMulti(allRows, statusSlicer);

      // Apply current multi-select filter
      const filtered = (salesFilters.size===0)
        ? allRows
        : allRows.filter(r => salesFilters.has(normStatus(r.status)));

      const activeKey = salesSort.key;
      const sorted = activeKey ? sortSales(filtered, activeKey, salesSort.asc) : filtered;

      if(!sorted.length){
        salesBody.innerHTML = `<tr><td colspan="7" class="muted">No sales entries found${salesFilters.size? ' for selected status':''}.</td></tr>`;
        salesSection.style.display = 'block'; updateSalesHeaderSortIndicators(); return;
      }
      const trHTML = sorted.map(r=>{
        const flag = flagFromStatus(r.status);
        return `<tr>
          <td>${fmtDate(r.date)}</td>
          <td>${r.project || '‚Äî'}</td>
          <td>${r.client || '‚Äî'}</td>
          <td>${r.unit || '‚Äî'}</td>
          <td><span class="pill ${pillClass(r.status)}">${normStatus(r.status)}</span></td>
          <td class="num">${fmtINR(r.revenue)}</td>
          <td class="num">${flag}</td>
        </tr>`;
      }).join('');
      salesBody.innerHTML = trHTML;
      salesSection.style.display='block';
      updateSalesHeaderSortIndicators();
    }

    /* ===== MATRIX (FOS only) ===== */
    function renderMatrix(){
      if(state.role!=='FOS' || !state.name){
        fosMatrixSection.style.display='none'; fosMatrixBody.innerHTML=''; return;
      }
      const emp = (employees["FOS"]||{})[state.name];
      if(!emp){ fosMatrixSection.style.display='none'; return; }
      const months = monthRange(emp.doj, emp.dol);
      const matrix = (matrixFOS[state.name] || {});
      let t={calls:0,connected:0,duration:0,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:0};

      const rows = months.map(m=>{
        const r = matrix[m.key] || {calls:0,connected:0,duration:0,svSched:0,svDone:0,mtgSched:0,mtgDone:0,dailyWork:0};
        t.calls+=r.calls||0; t.connected+=r.connected||0; t.duration+=r.duration||0;
        t.svSched+=r.svSched||0; t.svDone+=r.svDone||0; t.mtgSched+=r.mtgSched||0; t.mtgDone+=r.mtgDone||0; t.dailyWork+=r.dailyWork||0;
        return `<tr>
          <td>${m.label}</td>
          <td class="num">${r.calls||0}</td>
          <td class="num">${r.connected||0}</td>
          <td class="num">${r.duration||0}</td>
          <td class="num">${r.svSched||0}</td>
          <td class="num">${r.svDone||0}</td>
          <td class="num">${r.mtgSched||0}</td>
          <td class="num">${r.mtgDone||0}</td>
          <td class="num">${r.dailyWork||0}</td>
        </tr>`;
      }).join('');

      const totalsRow = `
        <tr class="totals-row">
          <td>Total</td>
          <td class="num">${t.calls}</td>
          <td class="num">${t.connected}</td>
          <td class="num">${t.duration}</td>
          <td class="num">${t.svSched}</td>
          <td class="num">${t.svDone}</td>
          <td class="num">${t.mtgSched}</td>
          <td class="num">${t.mtgDone}</td>
          <td class="num">${t.dailyWork}</td>
        </tr>`;
      fosMatrixBody.innerHTML = totalsRow + rows;
      fosMatrixSection.style.display='block';
    }

    /* ===== EXPORT / LOGOUT / INIT ===== */
    function tableToRows(table){
      const rows = [];
      const ths = table.querySelectorAll('thead th');
      rows.push(Array.from(ths).map(th=>th.textContent.trim()));
      const trs = table.querySelectorAll('tbody tr');
      trs.forEach(tr=>{
        const tds = Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.trim());
        rows.push(tds);
      });
      return rows;
    }
    function downloadCSV(filename, rows){
      const csv = rows.map(r=>r.map(v=>{
        const s = String(v ?? '');
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }
    function doExport(){
      if(!state.name){ alert('Please select a name first.'); return; }
      downloadCSV(`${state.name}_Summary.csv`,            tableToRows(document.getElementById('tblSummary')));
      downloadCSV(`${state.name}_Monthly_Performance.csv`,tableToRows(document.getElementById('tblPerformance')));
      downloadCSV(`${state.name}_Sales_Details.csv`,      tableToRows(document.getElementById('tblSales')));
      if(state.role==='FOS'){
        downloadCSV(`${state.name}_Input_Matrix.csv`,     tableToRows(document.getElementById('tblMatrix')));
      }
    }

    document.getElementById('btnLogout').addEventListener('click', ()=>{
      sessionStorage.removeItem('auth'); location.replace('index.html');
    });
    document.getElementById('btnExport').addEventListener('click', doExport);
    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
    document.getElementById('resetFilters').addEventListener('click', resetAll);

    function resetAll(){
      if(isAdmin){ searchInput.value=''; state.name=null; }
      else{
        state.role = lockedUserRole; roleSel.value = lockedUserRole;
        searchInput.value = lockedUserName||''; state.name = lockedUserName||null;
      }
      salesFilters = new Set(); // ALL
      closeAC(); renderAll(); searchInput.focus();
    }

    function renderAll(){
      updateDetails();
      updatePresident();
      renderSummary();
      renderPerformance();
      renderSales();
      renderMatrix();
    }

    (function init(){
      if(!isAdmin){
        roleSel.value = lockedUserRole; roleSel.disabled = true;
        searchInput.placeholder = lockedUserName ? 'Your name' : 'Name';
        searchInput.readOnly = true;
        state.role = lockedUserRole;
        state.name = lockedUserName || null;
        if(lockedUserName) searchInput.value = lockedUserName;
        loginInfo.textContent = `Logged in as: ${lockedUserName} (${lockedUserRole})`;
      }else{
        loginInfo.textContent = `Logged in as: ADMIN`;
      }

      if(state.name==null){
        const list = namesForRole(state.role);
        if(list.length){ state.name = list[0]; searchInput.value = state.name; }
      }

      renderAll();

      roleSel.addEventListener('change', e=>{
        state.role=e.target.value; state.name=null; searchInput.value='';
        salesFilters = new Set();
        closeAC(); renderAll();
      });
      searchInput.addEventListener('focus', ()=>{ if(isAdmin) refreshAC(); });
      searchInput.addEventListener('input', ()=>{ if(isAdmin) refreshAC(); });

      document.getElementById('salesHeaders').addEventListener('click', (e)=>{
        const th = e.target.closest('th'); if(!th || !th.dataset.sort) return;
        const key = th.dataset.sort;
        if(salesSort.key === key){ salesSort.asc = !salesSort.asc; } else { salesSort.key = key; salesSort.asc = true; }
        renderSales();
      });

      document.addEventListener('click', (e)=>{ if(!e.target.closest('.ac-wrap')) closeAC(); });
      searchInput.addEventListener('keydown', (e)=>{
        if(searchInput.readOnly) return;
        if(!acList.classList.contains('open')){
          if(e.key.length===1 || e.key==='Backspace' || e.key==='Delete' || e.key==='ArrowDown'){ refreshAC(); }
        }
        if(e.key==='ArrowDown'){ e.preventDefault(); moveActive(+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); moveActive(-1); }
        else if(e.key==='Enter'){ e.preventDefault(); const el = acList.querySelectorAll('.ac-item')[acIndex]; if(el) selectName(el.textContent.trim()); }
        else if(e.key==='Escape'){ closeAC(); }
      });
    })();
  </script>
</body>
</html>
